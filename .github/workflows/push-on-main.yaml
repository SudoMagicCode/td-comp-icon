name: Auto Tagging

on:
  push:
    branches:
      - main

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Essential for git describe and rev-list

      - name: Generate Version Number
        id: get_version
        run: |
          # 1. Get the latest tag (e.g., v1.2)
          # If no tags exist, fallback to v0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0")
          
          # 2. Get count of commits since that tag
          # If it's a fresh repo with no tags, count all commits
          if [ "$LATEST_TAG" = "v0.0" ]; then
            COUNT=$(git rev-list --count HEAD)
          else
            COUNT=$(git rev-list --count $LATEST_TAG..HEAD)
          fi

          # 3. Construct the hybrid version
          # This creates v1.2.x where x is the number of commits since v1.2
          VERSION="$LATEST_TAG.$COUNT"
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create and Push Tag
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{ steps.get_version.outputs.VERSION }}',
              sha: context.sha
            })